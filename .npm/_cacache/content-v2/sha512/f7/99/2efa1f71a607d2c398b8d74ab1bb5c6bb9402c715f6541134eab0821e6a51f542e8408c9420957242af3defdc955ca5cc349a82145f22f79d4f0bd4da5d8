{"_id":"@foxt/js-srp","_rev":"2-6f9561fc932348dbd4b695b1998e6a64","name":"@foxt/js-srp","dist-tags":{"latest":"0.0.3-patch2"},"versions":{"0.0.3":{"name":"@foxt/js-srp","version":"0.0.3","description":"js-srp modified to add support for the SRP implementation used by Apple's iCloud.com","main":"dist/index.node.cjs","browser":"dist/index.browser.js","module":"dist/index.node.mjs","types":"dist/index.d.ts","exports":{".":{"browser":"./dist/index.browser.js","require":"./dist/index.node.cjs","default":"./dist/index.node.mjs","types":"./dist/index.d.ts"}},"scripts":{"test":"npm run build:test && node ./dist/test.js","check":"tsc --noEmit","build":"npm run build:browser && npm run build:node:cjs && npm run build:node:esm && npm run build:types","build:browser":"esbuild --minify --bundle --platform=browser --inject:src/webcrypto.browser.ts --format=esm --outfile=dist/index.browser.js src/index.ts","build:node:cjs":"esbuild --minify --bundle --platform=node --inject:src/webcrypto.nodejs.cjs.ts --format=cjs --outfile=dist/index.node.cjs src/index.ts","build:node:esm":"esbuild --minify --bundle --platform=node --inject:src/webcrypto.nodejs.esm.ts --format=esm --outfile=dist/index.node.mjs src/index.ts","build:test":"esbuild --bundle --platform=node --inject:src/webcrypto.nodejs.esm.ts --format=esm --outfile=dist/test.js src/test.ts","build:types":"tsc --declaration --emitDeclarationOnly"},"author":{"name":"John Chadwick"},"repository":{"type":"git","url":"git+https://github.com/jchv/js-srp.git"},"license":"ISC","devDependencies":{"@types/node":"^18.7.23","esbuild":"^0.16.3","typescript":"^4"},"type":"module","_id":"@foxt/js-srp@0.0.3","gitHead":"bf8bfa833ca15e660896ab1d2b62c57d04e1f07a","bugs":{"url":"https://github.com/jchv/js-srp/issues"},"homepage":"https://github.com/jchv/js-srp#readme","_nodeVersion":"20.6.0","_npmVersion":"9.8.1","dist":{"integrity":"sha512-S1lsy/UsV/lST/u8pBs5XdlApsfllzg4lgC0i/AOO5WMdiKxfbllXvFdo0eOceg/hu5GHLxmoQfxOEeKTgFfOw==","shasum":"3c69201db1f0b534e0f5320b3cfc567348734970","tarball":"https://registry.npmjs.org/@foxt/js-srp/-/js-srp-0.0.3.tgz","fileCount":34,"unpackedSize":76713,"signatures":[{"keyid":"SHA256:jl3bwswu80PjjokCgh0o2w5c2U4LhQAE57gj9cz1kzA","sig":"MEUCIDX7n0k3xB20RTO6j9TuylpuOJJUi/t50c65wUhmlfBdAiEAnv/PvXCVt+87MPRvmAqNCE5x/HpPbN05+LyPtZ+p7RA="}]},"_npmUser":{"name":"foxt","email":"me@thelmgn.com"},"directories":{},"maintainers":[{"name":"foxt","email":"me@thelmgn.com"}],"_npmOperationalInternal":{"host":"s3://npm-registry-packages","tmp":"tmp/js-srp_0.0.3_1696983878115_0.7511731629155476"},"_hasShrinkwrap":false},"0.0.3-patch1":{"name":"@foxt/js-srp","version":"0.0.3-patch1","description":"js-srp modified to add support for the SRP implementation used by Apple's iCloud.com","main":"dist/index.node.cjs","browser":"dist/index.browser.js","module":"dist/index.node.mjs","types":"dist/index.d.ts","exports":{".":{"browser":"./dist/index.browser.js","require":"./dist/index.node.cjs","default":"./dist/index.node.mjs","types":"./dist/index.d.ts"}},"scripts":{"test":"npm run build:test && node ./dist/test.js","check":"tsc --noEmit","build":"npm run build:browser && npm run build:node:cjs && npm run build:node:esm && npm run build:types","build:browser":"esbuild --minify --bundle --platform=browser --inject:src/webcrypto.browser.ts --format=esm --outfile=dist/index.browser.js src/index.ts","build:node:cjs":"esbuild --minify --bundle --platform=node --inject:src/webcrypto.nodejs.cjs.ts --format=cjs --outfile=dist/index.node.cjs src/index.ts","build:node:esm":"esbuild --minify --bundle --platform=node --inject:src/webcrypto.nodejs.esm.ts --format=esm --outfile=dist/index.node.mjs src/index.ts","build:test":"esbuild --bundle --platform=node --inject:src/webcrypto.nodejs.esm.ts --format=esm --outfile=dist/test.js src/test.ts","build:types":"tsc --declaration --emitDeclarationOnly"},"author":{"name":"John Chadwick"},"repository":{"type":"git","url":"git+https://github.com/foxt/js-srp-gsa.git"},"license":"ISC","devDependencies":{"@types/node":"^18.7.23","esbuild":"^0.16.3","typescript":"^4"},"type":"module","_id":"@foxt/js-srp@0.0.3-patch1","gitHead":"bf8bfa833ca15e660896ab1d2b62c57d04e1f07a","bugs":{"url":"https://github.com/foxt/js-srp-gsa/issues"},"homepage":"https://github.com/foxt/js-srp-gsa#readme","_nodeVersion":"20.6.0","_npmVersion":"9.8.1","dist":{"integrity":"sha512-X6ZSped2ptv4mDdX1Bs3HbVq0Ae52MOvxt9isbFsDIdbjep6qWOqkzBwq4G/oemy9/Nho9ULkRGRnmBBtUgtfQ==","shasum":"fd83ada0aa4408fb292b7dd8d345e753a440b87f","tarball":"https://registry.npmjs.org/@foxt/js-srp/-/js-srp-0.0.3-patch1.tgz","fileCount":34,"unpackedSize":76724,"signatures":[{"keyid":"SHA256:jl3bwswu80PjjokCgh0o2w5c2U4LhQAE57gj9cz1kzA","sig":"MEUCIGVjXFA7d/V6kpzn760we0e+qO8yCEvtIuHDy8yIjFJ9AiEAve30LrXq0CwfiEiVye8Zb7Hk4vHPi3dtAvv1rWN2gEU="}]},"_npmUser":{"name":"foxt","email":"me@thelmgn.com"},"directories":{},"maintainers":[{"name":"foxt","email":"me@thelmgn.com"}],"_npmOperationalInternal":{"host":"s3://npm-registry-packages","tmp":"tmp/js-srp_0.0.3-patch1_1696984412455_0.11586652098625527"},"_hasShrinkwrap":false},"0.0.3-patch2":{"name":"@foxt/js-srp","version":"0.0.3-patch2","description":"js-srp modified to add support for the SRP implementation used by Apple's iCloud.com","main":"dist/index.node.cjs","browser":"dist/index.browser.js","module":"dist/index.node.mjs","types":"dist/index.d.ts","exports":{".":{"browser":"./dist/index.browser.js","require":"./dist/index.node.cjs","default":"./dist/index.node.mjs","types":"./dist/index.d.ts"}},"scripts":{"test":"npm run build:test && node ./dist/test.js","check":"tsc --noEmit","build":"npm run build:browser && npm run build:node:cjs && npm run build:node:esm && npm run build:types","build:browser":"esbuild --minify --bundle --platform=browser --inject:src/webcrypto.browser.ts --format=esm --outfile=dist/index.browser.js src/index.ts","build:node:cjs":"esbuild --minify --bundle --platform=node --inject:src/webcrypto.nodejs.cjs.ts --format=cjs --outfile=dist/index.node.cjs src/index.ts","build:node:esm":"esbuild --minify --bundle --platform=node --inject:src/webcrypto.nodejs.esm.ts --format=esm --outfile=dist/index.node.mjs src/index.ts","build:test":"esbuild --bundle --platform=node --inject:src/webcrypto.nodejs.esm.ts --format=esm --outfile=dist/test.js src/test.ts","build:types":"tsc --declaration --emitDeclarationOnly"},"author":{"name":"John Chadwick"},"repository":{"type":"git","url":"git+https://github.com/foxt/js-srp-gsa.git"},"license":"ISC","devDependencies":{"@types/node":"^18.7.23","esbuild":"^0.16.3","typescript":"^4"},"type":"module","_id":"@foxt/js-srp@0.0.3-patch2","gitHead":"98b5a811f2c9c606861708e72e732ba4c1b6c075","bugs":{"url":"https://github.com/foxt/js-srp-gsa/issues"},"homepage":"https://github.com/foxt/js-srp-gsa#readme","_nodeVersion":"20.6.0","_npmVersion":"9.8.1","dist":{"integrity":"sha512-mCjMIf+/mwmuzSGr8CWWQDjDUqMBnw9TBnzfcBUTR2ySPoXcg6Pfb4/WPklY1TwY3Pe3f3r8q6hzWvvogInuug==","shasum":"0f0d9c10d43087847f4e3c7b6a5de12cdb827a8e","tarball":"https://registry.npmjs.org/@foxt/js-srp/-/js-srp-0.0.3-patch2.tgz","fileCount":34,"unpackedSize":80532,"signatures":[{"keyid":"SHA256:jl3bwswu80PjjokCgh0o2w5c2U4LhQAE57gj9cz1kzA","sig":"MEQCIGGNJo/BJ+3yG0hFj3zZKPrftn4hYoGeP2RwkIWvW2eQAiACaThXkwAK8SnFuBdJVgi2ZiMgo687g3UGsx01jgoshg=="}]},"_npmUser":{"name":"foxt","email":"me@thelmgn.com"},"directories":{},"maintainers":[{"name":"foxt","email":"me@thelmgn.com"}],"_npmOperationalInternal":{"host":"s3://npm-registry-packages","tmp":"tmp/js-srp_0.0.3-patch2_1709213186813_0.7767600776069845"},"_hasShrinkwrap":false}},"time":{"created":"2023-10-11T00:24:37.999Z","0.0.3":"2023-10-11T00:24:38.433Z","modified":"2024-02-29T13:26:27.386Z","0.0.3-patch1":"2023-10-11T00:33:32.760Z","0.0.3-patch2":"2024-02-29T13:26:26.990Z"},"maintainers":[{"name":"foxt","email":"me@thelmgn.com"}],"description":"js-srp modified to add support for the SRP implementation used by Apple's iCloud.com","homepage":"https://github.com/foxt/js-srp-gsa#readme","repository":{"type":"git","url":"git+https://github.com/foxt/js-srp-gsa.git"},"author":{"name":"John Chadwick"},"bugs":{"url":"https://github.com/foxt/js-srp-gsa/issues"},"license":"ISC","readme":"# js-srp-gsa\n\nThis is a fork of [`js-srp`](https://github.com/jchv/js-srp) that adds support for the variant of SRP used by Apple icloud.com.\n\n## Example usage\n\n### SRP wrapper\n```ts\nimport { Client, Hash, Mode, Srp, util } from \"@foxt/js-srp\";\nimport crypto from \"crypto\";\n\nexport type SRPProtocol = \"s2k\" | \"s2k_fo\";\n\nexport interface ServerSRPInitRequest {\n    a: string;\n    accountName: string;\n    protocols: SRPProtocol[];\n}\nexport interface ServerSRPInitResponse {\n    iteration: number;\n    salt: string;\n    protocol: \"s2k\" | \"s2k_fo\";\n    b: string;\n    c: string;\n}\nexport interface ServerSRPCompleteRequest {\n    accountName: string;\n    c: string;\n    m1: string;\n    m2: string;\n    rememberMe: boolean;\n    trustTokens: string[];\n}\n\nlet srp = new Srp(Mode.GSA, Hash.SHA256, 2048);\nconst stringToU8Array = (str: string) => new TextEncoder().encode(str);\nconst base64ToU8Array = (str: string) => Uint8Array.from(Buffer.from(str, \"base64\"));\nexport class GSASRPAuthenticator {\n    constructor(private username: string) { }\n    private srpClient?: Client = undefined;\n\n\n    private async derivePassword(protocol: \"s2k\" | \"s2k_fo\", password: string, salt: Uint8Array, iterations: number) {\n        let passHash = new Uint8Array(await util.hash(srp.h, stringToU8Array(password)));\n        if (protocol == \"s2k_fo\") {\n            passHash = stringToU8Array(util.toHex(passHash));\n        }\n\n        let imported = await crypto.subtle.importKey(\n            \"raw\",\n            passHash,\n            { name: \"PBKDF2\" },\n            false,\n            [\"deriveBits\"]\n        );\n        let derived = await crypto.subtle.deriveBits({\n            name: \"PBKDF2\",\n            hash: { name: \"SHA-256\" },\n            iterations, salt\n        }, imported, 256);\n\n        return new Uint8Array(derived);\n    }\n\n\n    async getInit(): Promise<ServerSRPInitRequest> {\n        if (this.srpClient) throw new Error(\"Already initialized\");\n        this.srpClient = await srp.newClient(\n            stringToU8Array(this.username),\n            // provide fake passsword because we need to get data from server\n            new Uint8Array()\n        );\n        let a = Buffer.from(\n            util.bytesFromBigint(this.srpClient.A)\n        ).toString(\"base64\");\n        return {\n            a, protocols: [\"s2k\", \"s2k_fo\"],\n            accountName: this.username,\n        };\n    }\n    async getComplete(password: string, serverData: ServerSRPInitResponse): Promise<Pick<ServerSRPCompleteRequest, \"m1\" | \"m2\" | \"c\" | \"accountName\">> {\n        if (!this.srpClient) throw new Error(\"Not initialized\");\n        if ((serverData.protocol != \"s2k\") &&\n            (serverData.protocol != \"s2k_fo\")) throw new Error(\"Unsupported protocol \" + serverData.protocol);\n        let salt = base64ToU8Array(serverData.salt);\n        let serverPub = base64ToU8Array(serverData.b);\n        let iterations = serverData.iteration;\n        let derived = await this.derivePassword(\n            serverData.protocol, password,\n            salt, iterations\n        );\n        this.srpClient.p = derived;\n        await this.srpClient.generate(salt, serverPub);\n        let m1 = Buffer.from(this.srpClient._M).toString(\"base64\");\n        let M2 = await this.srpClient.generateM2();\n        let m2 = Buffer.from(M2).toString(\"base64\");\n        return {\n            accountName: this.username,\n            m1,\n            m2,\n            c: serverData.c,\n        };\n    }\n}\n```\n\n### API interop\n```ts\nimport prompt from \"prompt\";\nimport type { ServerSRPInitResponse } from \"./GSASRPAuthenticator.js\";\nimport { GSASRPAuthenticator } from \"./GSASRPAuthenticator.js\";\n\nasync function request(url: string, body: any) {\n    let req = await fetch(\"https://idmsa.apple.com/appleauth/auth/signin\" + url, {\n        method: \"POST\",\n        headers: {\n            \"Content-Type\": \"application/json\",\n            \"Accept\": \"application/json, text/javascript, */*; q=0.01\",\n        },\n        body: JSON.stringify(body)\n    })\n    console.log()\n    console.log(\"POST\", url)\n    console.log(\"    \", req.status, req.statusText)\n\n    if (!req.ok) throw new Error(\n        \"Failed to get init response \" + req.status + \" \" + req.statusText + \": \" \n        + await req.text()\n    );\n    return await req.json();\n}\n\n\nasync function login(username: string, password: string) {\n    // set up SRP authenticator & get public key\n    let authenticator = new GSASRPAuthenticator(username);\n    let initData = await authenticator.getInit();\n\n    // request SRP init data from server\n    let initResp = await request(\"/init\", initData)\n    \n\n    // get proof of password\n    let proof = await authenticator.getComplete(password, initResp as ServerSRPInitResponse);\n\n    // send proof to server\n    let completeResp = await request(\"/complete\", {\n            ...proof,\n            rememberMe: true,\n            trustTokens: []\n    })\n    console.log(completeResp)\n\n    \n}\nprompt.start();\nprompt.get({\n    properties: {\n        username: {\n            description: \"Apple ID\"\n        },\n        password: {\n            description: \"Password\",\n            hidden: true\n        }\n    }\n}, (err, result) => {\n    if (err) return console.error(err);\n    login(result.username as string, result.password as string).catch(console.error);\n})\n\n\n```","readmeFilename":"README.md"}